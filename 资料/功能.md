# 功能

##

## 文件上传
http://localhost:8082/file/download/头像1.jpg

- 1:文件上传，先将文件切片成N个object
- 2:切片后的文件object会存入到Ceph中

- 使用分布式存储系统Ceph来实现商品图片,视频的上传和下载,
- 高可靠性和冗余：
Ceph 使用分布式对象存储技术，数据被分散存储在多个存储节点上，每个对象都有多个副本（通过副本数或者纠删码配置），这样即使某个节点或者磁盘发生故障，数据仍然可以通过其他副本或者纠删码重建出来，从而保证数据的高可靠性和持久性。

- 高性能：
Ceph 的架构设计充分利用了集群的并行处理能力和存储节点的整合，能够提供高吞吐量和低延迟的数据访问能力。这对于需要大规模、高速数据上传和下载的应用场景非常重要，如大数据分析、科学计算等。

- 可扩展性：
Ceph 集群可以根据需求进行水平扩展，通过添加更多的存储节点来增加存储容量和吞吐量。这种扩展性使得系统能够应对不断增长的数据需求，而不需要重新设计整个系统。

- 访问灵活
Ceph 提供了多种访问方式，包括对象存储、块存储和文件系统，可以根据应用的需求选择合适的访问方式进行数据上传和下载。

- 统一管理：
Ceph提供了统一的管理接口和网页管理工具 Ceph Dashboard，能够方便地管理和监控整个存储集群。这简化了管理和运维的复杂性，提高了管理效率。

## 服务器访问使用三级缓存
http://localhost:8081/sku/aditems/type/1
- 三级缓存
  1. redis缓存
     - 缓存访问量的接口信息,比如首页的推广商品的详细信息
  2. nginx缓存
      - 所有静态资源，经过Nginx，Nginx直接从指定磁盘中获取文件，然后IO输出给用户
      - 商品详情页使用Thymeleaf模板引擎动态生成静态页到磁盘上
      - 在Nginx的时候使用Lua脚本查询Redis
      - 使用purge模块实现接口.一个清理缓存的地址：http://yougoushop.com/purge/sku/aditems/type?id=1
  3. Tomcat
    -最终由tomcat处理请求
- 访问过程
    1. 请求首先来到nginx
    2. Nginx使用Lua脚本查询Redis，
       - 如果Redis有数据，则将数据存入到Nginx缓存，再将数据响应给用户
    3. Nginx查询自身缓存
    4. Nginx查询真实服务器 
- 缓存一致性
  - 基于 MySQL 数据库增量日志解析
  - 通过Canal监听数据库变更，并实时消费变更数据，并更新缓存。

## 商品搜索
es索引http://8.134.222.236:39100/
localhost:8084/search?keywords=华为
- 索引构建
  - Canal微服务同步数据库的更新
- ElasticSearch搜索引擎实现全文搜索
- ElasticSearch搜索引擎实现关键词高亮

## 商品详情页使用Thymeleaf模板引擎动态生成静态页到磁盘上
- http://localhost:8087/cart/1319051488240168961/1

商品详情页静态化处理
2)Vue+Thymeleaf静态页属性切换
canal实现静态页实时更新

## 购物车
- MongoDB 是一个面向文档存储的数据库，操作起来比较简单和容易。
  - 复杂的查询和聚合操作支持性差
  - 不使用Redis是因为购物车量大。购物车数据有保存时间长的需求
  - 购物车以用户为对象存到mongoDB里去
  
### 订单工程
#### Seata创建分布式事务组,实现跨库跨表跨应用事务
下单流程
1、根据用户勾选的购物车ID查询购物车记录
2、实现库存递减 sku表
3、库存递减成功后，将购物车商品存入到订单明细中
4、添加订单
5、删除当前操作的购物车数据
6 用户支付
7 确认是否支付

#### 数据最终一分布式事务
- rocketmq实现下单后,支付成功改变订单状态
- 支付微服务发送事务消息
- order监听事务消息,确认下单

#### 网关鉴权
1.使用JWT令牌实现鉴权机制
2:Canal监听MySQL中权限变更日志，并将变更数据同步到Redis
3:Gateway拦截用户所有请求，在Gateway中加载Redis里用户的权限
4:在Gateway中加载权限后，对当前用户请求操作进行权限判断
5:如果有权限，则放行，没有权限，则拦截
- JWT令牌传输用户信息
- 非对称加密算法加密令牌


  